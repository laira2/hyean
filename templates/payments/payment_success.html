{% extends 'base.html' %}
{% load static %}
{% block content %}


<h1>주문 내역</h1>
{% if error_message %}
<h1>{{ error_message }}</h1>
{%else %}
<table class="table">
    <thead>
    <tr>
        <th>주문일시 : <span>{{ order_datetime }}</span></th>
        <th></th>
        <th>주문번호 : <span>{{ orderId }}</span></th>
        <th></th>
    </tr>
    <tr>
        <th scope="col"></th>
        <th scope="col">작품명</th>
        <th scope="col"></th>
        <th scope="col">가격</th>
    </tr>
    </thead>
    <tbody>
    {% for item in order_items %}
    <tr>
        <td>
            <img src="{{ item.image_url }}" alt="{{ art_name }}" style="max-width: 150px;">
        </td>
        <td class="align-middle">{{ item.art_name }}</td>
        <td class="align-middle"></td>
        <td class="num align-middle">${{ item.price }}</td>
    </tr>
    {% endfor %}

    </tbody>
</table>
{% endif %}

<div class="order_wrap" style="text-align: center;">

</div>

<table class="table">
    <thead>
    <tr>
        <th scope="col">이름</th>
        <th scope="col">전화번호</th>
        <th scope="col">배송지</th>
        <th scope="col">이메일</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <th scope="row">{{ name }}</th>
        <td>{{ phone }}</td>
        <td>{{ address }}</td>
        <td>{{ email }}</td>
    </tr>
    </tbody>
</table>
<div class="order_info" style="text-align: center; margin: 20px 0;">
    <a href="{% url 'index' %}">
        <button class="btn btn-primary" type="submit">메인으로</button>
    </a>
</div>
<!--<h2>결제 성공</h2>-->
<!--<p id="paymentKey"></p>-->
<!--<p id="orderId"></p>-->
<!--<p id="amount"></p>-->
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const paymentKey = urlParams.get("paymentKey");
    const orderId = urlParams.get("orderId");
    const amount = urlParams.get("amount");

    async function confirm() {
        const requestData = { paymentKey, orderId, amount };

        const response = await fetch("/confirm/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
        });

        const json = await response.json();

        if (!response.ok) {
            console.log(json);
            window.location.href = `/fail?message=${json.message}&code=${json.code}`;
        }

        console.log(json);
    }

    confirm();

    document.getElementById("paymentKey").textContent = `paymentKey: ${paymentKey}`;
    document.getElementById("orderId").textContent = `주문번호: ${orderId}`;
    document.getElementById("amount").textContent = `결제 금액: ${amount}`;
</script>
{% endblock %}
